| BIN-2024-0003 | `CHECKSIGFROMSTACK`
| :------------ | :-------
| Revision      | 000 (2024-01-17)
| Author        | Brandon Black `<freedom@reardencode.com>`
| |
| Layer         | Consensus (soft fork)
| Status        | Draft
| License       | BSD-3-CLAUSE
| |
| Discussion    | https://delvingbitcoin.org/t/lnhance-bips-and-implementation/376/9
| Aliases       | [BIPs PR#1535](https://github.com/bitcoin/bips/pull/1535)

## Abstract

This BIP describes two new opcode for the purpose of checking cryptographic
signatures in bitcoin scripts against data other than bitcoin transactions.

## Summary

We propose replacing `OP_NOP5` (0xb4) in bitcoin script with
`OP_CHECKSIGFROMSTACKVERIFY`. When verifying taproot script spends having
leaf version 0xc0 (as defined in BIP342), we propose `OP_CHECKSIGFROMSTACK`
to replace `OP_SUCCESS204` (0xcc).

`OP_CHECKSIGFROMSTACK` and `OP_CHECKSIGFROMSTACKVERIFY`
have semantics similar to `OP_CHECKSIG` and
`OP_CHECKSIGVERIFY` respectively, as specified below.

For legacy and segwit v0 scripts, 32-byte and 33-byte keys are supported for
BIP340 signature verification and ECDSA signature verification respectively.

## Specification

* If fewer than 3 elements are on the stack, the script MUST fail and terminate immediately.
* The public key (top element), message (second to top element), and signature (third from top element) are read from the stack.
* For `OP_CHECKSIGFROMSTACK` the top three elements are popped from the stack.
* If the public key size is zero, the script MUST fail and terminate immediately.
* If the public key size is 32 bytes, it is considered to be a public key as described in BIP340:
    * If the signature is not the empty vector, the signature is validated against the public key and message according to BIP340. Validation failure in this case immediately terminates script execution with failure.
* For legacy and segwit v0 scripts, if the public key size is 33 bytes and its first byte is 0x02 or 0x03, it is considered a compressed public key as described in BIP137:
    * If the signature is not the empty vector, the signature is validated against the public key and message using ECDSA. Validation failure in this case immediately terminates script execution with failure.
* If the public key size is not zero, and it is not a BIP340 public key, nor a BIP137 compressed public key; the public key is of an unknown public key type, and no actual signature verification is applied. During script execution of signature opcodes they behave exactly as known public key types except that signature validation is considered to be successful.
* If the script did not fail and terminate before this step, regardless of the public key type:
    * If the signature is the empty vector:
        * For `OP_CHECKSIGFROMSTACKVERIFY`, the script MUST fail and terminate immediately.
        * For `OP_CHECKSIGFROMSTACK`, an empty vector is pushed onto the stack, and execution continues with the next opcode.
    * If the signature is not the empty vector:
        * For tapscript 0xc0, the opcode is counted towards the sigops budget as described in BIP341.
        * For legacy and segwit v0, the opcode is counted towards the sigops limit, as described in BIP141
        * For `OP_CHECKSIGFROMSTACKVERIFY`, execution continues without any further changes to the stack.
        * For `OP_CHECKSIGFROMSTACK`, a 1-byte value 0x01 is pushed onto the stack.

## Design Considerations

1. Message hashing: ECDSA requires the message to be securely hashed to 32-bytes before being used in the signing protocol, so a SHA256 hash is taken before the message is passed for ECDSA signing. BIP340 is compatible with any size of message and does not require it to be a securely hashed input, so the message is not hashed prior to BIP340 signing.
2. Verify NOP upgrade: To bring both ECDSA and BIP340 signing to bitcoin script, a NOP upgrade path was chosen for `OP_CHECKSIGFROMSTACKVERIFY`. This necessarily means leaving the 3 arguments on the stack when executing `OP_CHECKSIGFROMSTACKVERIFY`. Scripts will need to drop or otherwise manage these stack elements.
3. Add/multisig: No concession is made to `OP_CHECKMULTISIG` or `OP_CHECKSIGADD` semantics with `OP_CHECKSIGFROMSTACK(VERIFY)`. In Tapscript, add semantics can be implemented with 1 additional vByte per key (`OP_TOALTSTACK OP_CHECKSIGFROMSTACK OP_FROMALTSTACK OP_ADD OP_TOALTSTACK`).
4. Splitting R/S on the stack: Implementing split/separate signatures is left as an exercise for future bitcoin upgrades, such as `OP_CAT`.
5. BIP118-style Taproot internal key: Rather than introducing an additional key type in this change, we suggest implementing OP_INTERNALKEY or separately introducing that key type for all Tapscript signature checking operations in a separate change.
6. Unknown key lengths: The semantics of other signature checking opcodes in their respective script types (legacy, segwit-v0, tapscript-c0) are applied.

## Resource Limits

These opcodes are treated identically to other signature checking opcodes and
count against the various sigops limits and budgets in their respective script
types.

## Motivation

### LN Symmetry

When combined with `OP_CHECKTEMPLATEVERIFY` (BIP119/CTV),
`OP_CHECKSIGFROMSTACK` (CSFS) can be used in Lightning Symmetry channels.
The construction `OP_CHECKTEMPLATEVERIFY <pubkey> OP_CHECKSIGFROMSTACK` is
logically equivalent to `<bip118_pubkey> OP_CHECKSIG` and a signature over
`SIGHASH_ALL|SIGHASH_ANYPREVOUTANYSCRIPT`. The `OP_CHECKSIGFROMSTACK`
construction is 8 vBytes larger.

### Delegation

Using a script like:
`OP_DUP <pubkey> OP_CHECKSIGFROMSTACK OP_DROP OP_CHECKSIG`
A script can delegate signing to another key.

## Reference Implementation

A reference implementation is provided in provided here:

https://github.com/brandonblack/bitcoin/commit/5aae0503ceab93101c459748347a111e4a4852c4

## Backward Compatibility

By constraining the behavior of an OP_SUCCESS opcode and an OP_NOP opcode,
deployment of the BIP can be done in a backwards compatible, soft-fork manner.
If anyone were to rely on the OP_SUCCESS behavior of
`OP_SUCCESS204`, `OP_CHECKSIGFROMSTACK` would invalidate
their spend.

## Deployment

TBD

## Credits

Reference implementation was made with reference to the implementation in
Elements and started by moonsettler.

## References

[BIP 119](https://github.com/bitcoin/bips/blob/master/bip-0119.mediawiki) CHECKTEMPLATEVERIFY

[BIP 118](https://github.com/bitcoin/bips/blob/master/bip-0119.mediawiki) SIGHASH_ANYPREVOUT

[BIP 340](https://github.com/bitcoin/bips/blob/master/bip-0341.mediawiki) Schnorr Signatures

[BIP 341](https://github.com/bitcoin/bips/blob/master/bip-0341.mediawiki) Taproot

[BIP 342](https://github.com/bitcoin/bips/blob/master/bip-0342.mediawiki) Tapscript

[OP_CAT](https://github.com/EthanHeilman/op_cat_draft/blob/main/cat.mediawiki)

## Copyright

This document is licensed under the 3-clause BSD license.
